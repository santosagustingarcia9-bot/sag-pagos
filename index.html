<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SAG & SK - Payment</title>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <style>
    body{
      font-family: Arial;
      background:#f4f4f4;
      display:flex;
      justify-content:center;
      padding:20px;
    }
    .card{
      background:white;
      padding:20px;
      border-radius:12px;
      width:100%;
      max-width:400px;
      box-shadow:0 5px 20px rgba(0,0,0,0.1);
    }
    .btn{
      width:100%;
      padding:14px;
      background:linear-gradient(90deg,#6a5cff,#8f6bff);
      color:white;
      border:none;
      border-radius:8px;
      font-weight:bold;
      cursor:pointer;
      margin-top:10px;
    }
    .resumen{
      background:#eee;
      padding:10px;
      border-radius:8px;
      margin-bottom:20px;
      display:flex;
      justify-content:space-between;
    }
    input{
      width:100%;
      padding:10px;
      margin:5px 0;
      border-radius:6px;
      border:1px solid #ccc;
    }
  </style>
</head>
<body>

<div class="card">

  <h2>SAG & SK</h2>
  <h3>Resumen de compra</h3>

  <div class="resumen">
    <span>Combinada del día</span>
    <span>$ 5000 ARS</span>
  </div>

  <!-- BOTÓN MERCADOPAGO -->
  <button class="btn" onclick="pagarMP()">Pagar con MercadoPago</button>

  <hr><br>

  <!-- CARD FORM -->
  <form id="form-checkout">

    <div id="form-checkout__cardNumber"></div>
    <div id="form-checkout__expirationDate"></div>
    <div id="form-checkout__securityCode"></div>

    <input type="text" id="form-checkout__cardholderName" placeholder="Nombre completo" />

    <select id="form-checkout__issuer"></select>

    <select id="form-checkout__installments"></select>

    <select id="form-checkout__identificationType"></select>

    <input type="text" id="form-checkout__identificationNumber" placeholder="DNI" />

    <input type="email" id="form-checkout__email" placeholder="Email" />

    <button type="submit" class="btn">Confirmar pago</button>

  </form>

</div>

<script>
const mp = new MercadoPago("APP_USR-afc13ecc-e106-4c83-9b96-6df76a8e2c8e", {
  locale: "es-AR"
});

// ====================
// BOTÓN CHECKOUT MP
// ====================
async function pagarMP() {

  const response = await fetch("/crear-preferencia", {
    method: "POST"
  });

  const data = await response.json();

  mp.checkout({
    preference: {
      id: data.id
    },
    autoOpen: true
  });
}

// ====================
// CARD FORM OFICIAL
// ====================
const cardForm = mp.cardForm({
  amount: "5000",
  autoMount: true,
  form: {
    id: "form-checkout",
    cardNumber: { id: "form-checkout__cardNumber" },
    expirationDate: { id: "form-checkout__expirationDate" },
    securityCode: { id: "form-checkout__securityCode" },
    cardholderName: { id: "form-checkout__cardholderName" },
    issuer: { id: "form-checkout__issuer" },
    installments: { id: "form-checkout__installments" },
    identificationType: { id: "form-checkout__identificationType" },
    identificationNumber: { id: "form-checkout__identificationNumber" },
    cardholderEmail: { id: "form-checkout__email" }
  },
  callbacks: {
    onSubmit: async (event) => {
      event.preventDefault();

      const {
        paymentMethodId,
        issuerId,
        token,
        installments,
        identificationType,
        identificationNumber,
        cardholderEmail
      } = cardForm.getCardFormData();

      const response = await fetch("/procesar-pago", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token,
          installments,
          paymentMethodId,
          issuerId,
          email: cardholderEmail,
          identificationType,
          identificationNumber
        })
      });

      const result = await response.json();

      if(result.status === "approved"){
        alert("✅ Pago aprobado");
      }else{
        alert("❌ Pago rechazado: " + result.status_detail);
      }
    }
  }
});
</script>

</body>
</html>

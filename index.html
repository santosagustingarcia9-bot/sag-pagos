<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAG & SK - Payment</title>

<script src="https://sdk.mercadopago.com/js/v2"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}

.card{
  background:white;
  width:360px;
  padding:25px;
  border-radius:15px;
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
}

h2{
  text-align:center;
  margin-bottom:10px;
}

.resumen{
  background:#eee;
  padding:10px;
  border-radius:10px;
  display:flex;
  justify-content:space-between;
  margin-bottom:20px;
}

.method{
  border:2px solid #eee;
  padding:15px;
  border-radius:12px;
  text-align:center;
  margin-bottom:15px;
  cursor:pointer;
  transition:0.3s;
}

.method:hover{
  border-color:#7b5cff;
}

.method img{
  height:30px;
  margin:5px;
}

.btn{
  background:linear-gradient(90deg,#7b5cff,#5f3bff);
  color:white;
  border:none;
  padding:12px;
  width:100%;
  border-radius:10px;
  font-size:16px;
  cursor:pointer;
}

#form-checkout{
  overflow:hidden;
  max-height:0;
  transition:max-height 0.6s ease, opacity 0.4s ease;
  opacity:0;
}

#form-checkout.active{
  max-height:600px;
  opacity:1;
  margin-top:15px;
}

input, select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}
</style>
</head>

<body>

<div class="card">

<h2>SAG & SK</h2>

<div class="resumen">
  <span>Combinada del día</span>
  <span>$ 5000 ARS</span>
</div>

<!-- MERCADOPAGO -->
<div class="method" onclick="pagarMP()">
  <img src="https://logodownload.org/wp-content/uploads/2014/07/mercado-pago-logo.png">
  <p>Pagar con MercadoPago</p>
</div>

<!-- TARJETA -->
<div class="method" onclick="mostrarTarjeta()">
  <img src="https://img.icons8.com/color/48/visa.png"/>
  <img src="https://img.icons8.com/color/48/mastercard.png"/>
  <img src="https://img.icons8.com/color/48/amex.png"/>
  <p>Pagar con tarjeta débito o crédito</p>
</div>

<!-- FORMULARIO OFICIAL -->
<form id="form-checkout">

  <div id="form-checkout__cardNumber"></div>
  <div id="form-checkout__expirationDate"></div>
  <div id="form-checkout__securityCode"></div>

  <input type="text" id="form-checkout__cardholderName" placeholder="Nombre completo" />

  <select id="form-checkout__issuer"></select>
  <select id="form-checkout__installments"></select>
  <select id="form-checkout__identificationType"></select>

  <input type="text" id="form-checkout__identificationNumber" placeholder="DNI" />
  <input type="email" id="form-checkout__email" placeholder="Email" />

  <button type="submit" class="btn">Confirmar pago</button>

</form>

</div>

<script>
const mp = new MercadoPago("APP_USR-afc13ecc-e106-4c83-9b96-6df76a8e2c8e", { locale: "es-AR" });

function mostrarTarjeta(){
  document.getElementById("form-checkout").classList.toggle("active");
}

async function pagarMP(){
  const response = await fetch("/crear-preferencia",{method:"POST"});
  const data = await response.json();

  mp.checkout({
    preference:{ id:data.id },
    autoOpen:true
  });
}

const cardForm = mp.cardForm({
  amount:"5000",
  autoMount:true,
  form:{
    id:"form-checkout",
    cardNumber:{ id:"form-checkout__cardNumber" },
    expirationDate:{ id:"form-checkout__expirationDate" },
    securityCode:{ id:"form-checkout__securityCode" },
    cardholderName:{ id:"form-checkout__cardholderName" },
    issuer:{ id:"form-checkout__issuer" },
    installments:{ id:"form-checkout__installments" },
    identificationType:{ id:"form-checkout__identificationType" },
    identificationNumber:{ id:"form-checkout__identificationNumber" },
    cardholderEmail:{ id:"form-checkout__email" }
  },
  callbacks:{
    onSubmit:async(event)=>{
      event.preventDefault();

      const data = cardForm.getCardFormData();

      const response = await fetch("/procesar-pago",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          amount:5000,
          token:data.token,
          installments:data.installments,
          paymentMethodId:data.paymentMethodId,
          issuerId:data.issuerId,
          identificationType:data.identificationType,
          identificationNumber:data.identificationNumber
        })
      });

      const result = await response.json();

      if(result.status==="approved"){
        alert("✅ Pago aprobado");
      }else{
        alert("❌ Pago rechazado");
      }
    }
  }
});
</script>

</body>
</html>
